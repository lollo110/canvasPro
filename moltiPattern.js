const canva = document.querySelector("canvas");
const context = canva.getContext("2d");

function resizeCanvas() {
  canva.width = window.innerWidth;
  canva.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', () => {
  resizeCanvas();
  createPatterns();
});

let patterns = [];
const SPEED = 200;
const minSize = 3; // dimensione minima punti

const palettes = [
  { 1: "#27397A", 2: "#4D72B3", 3: "#F2D24F", 4: "#936B30" },
  { 1: "#FFD700", 2: "#FFA500", 3: "#FFF", 4: "#000" },
  { 1: "#32CD32", 2: "#228B22", 3: "#000", 4: "#FFF" },
];

class Cucito {
  constructor(x, y, size, color) {
    this.x = x;
    this.y = y;
    this.size = size;
    this.color = color;
    this.state = 0;
    this.progress = 0;
  }

  drawSegment(x1, y1, x2, y2, p) {
    const midX = x1 + (x2 - x1) * p + Math.sin(p * Math.PI) * 1.2;
    const midY = y1 + (y2 - y1) * p + Math.cos(p * Math.PI) * 1.2;
    const width = 2.5 + Math.sin(p * Math.PI) * 1.2;

    // filo ombra
    context.strokeStyle = "rgba(0,0,0,0.25)";
    context.lineWidth = width + 2;
    context.beginPath();
    context.moveTo(x1 + 1.5, y1 + 1.5);
    context.lineTo(midX + 1.5, midY + 1.5);
    context.stroke();

    // filo principale
    context.strokeStyle = this.color;
    context.lineCap = "round";
    context.lineWidth = width;
    context.beginPath();
    context.moveTo(x1, y1);
    context.lineTo(midX, midY);
    context.stroke();

    return { x: midX, y: midY };
  }

  draw(offsetX = 0, offsetY = 0) {
    let needlePos = null;

    const x = this.x + offsetX;
    const y = this.y + offsetY;

    if (this.state === 1)
      needlePos = this.drawSegment(
        x,
        y,
        x + this.size,
        y + this.size,
        this.progress,
      );

    if (this.state >= 2)
      this.drawSegment(x, y, x + this.size, y + this.size, 1);

    if (this.state === 3)
      needlePos = this.drawSegment(
        x + this.size,
        y,
        x,
        y + this.size,
        this.progress,
      );

    if (this.state >= 4)
      this.drawSegment(x + this.size, y, x, y + this.size, 1);

    return needlePos;
  }

  update() {
    if (this.state === 1 || this.state === 3) {
      this.progress += SPEED;
      if (this.progress >= 1) {
        this.progress = 0;
        this.state++;
      }
    }
  }
}

class PatternStitches {
  constructor(pattern, palette, offsetX, offsetY, size) {
    this.stitches = [];
    this.colorGroups = {};
    pattern.forEach((row, y) => {
      row.forEach((cell, x) => {
        if (cell !== 0) {
          const s = new Cucito(offsetX + x * size, offsetY + y * size, size, palette[cell]);
          this.stitches.push(s);
          if (!this.colorGroups[s.color]) this.colorGroups[s.color] = [];
          this.colorGroups[s.color].push(s);
        }
      });
    });
    this.colors = Object.keys(this.colorGroups);
    this.colorIndex = 0;
    this.stitchIndex = 0;
    
  }

  draw() {
    this.stitches.forEach(s => s.draw());
  }

  update() {
    const currentColor = this.colors[this.colorIndex];
    const group = this.colorGroups[currentColor];
    const stitch = group?.[this.stitchIndex];
    if (!stitch) return;

    if (stitch.state === 0) stitch.state = 1;
    stitch.update();
    if (stitch.state === 2) stitch.state = 3;
    if (stitch.state === 4) this.stitchIndex++;

    if (this.stitchIndex >= group.length) {
      this.stitchIndex = 0;
      this.colorIndex++;
      if (this.colorIndex >= this.colors.length) this.colorIndex = 0;
    }
  }
}

const butterflyPattern = [
  [1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,1,1,0,0,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,0,1,1,1,1,1,0],
  [0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,0,0,1,0,0,0,0,1,1,0,0,1,1,1,1,1,0,0,1,1,0,1,1,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,1,0,0,1,1,1,1,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,0,0,0,0,1,1],
  [0,0,1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,1,1,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1,1,1,1,1,1,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,1,1,1,1,1,1],
  [0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0,0,0,0,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0,1],
  [0,1,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0,1,1,0,0,0,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,1,1,1,1,1,0],
];

const lettreV = [
  [0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0],
  [1,1,1,1,1,0,0,1,1,1],
  [0,1,1,1,0,0,0,0,1,0],
  [0,0,1,1,0,0,0,1,0,0],
  [0,0,1,1,0,0,0,1,0,0],
  [0,0,0,1,1,0,1,0,0,0],
  [0,0,0,1,1,0,1,0,0,0],
  [0,0,0,0,1,1,0,0,0,0],
  [0,0,0,0,1,1,0,0,0,0],
  [0,0,0,0,0,1,0,0,0,0]
];

const lettreU = [
  [0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0],
  [1,1,1,1,0,0,1,1,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,0,1,1,0],
  [0,0,1,1,0,0,0,1,1,1,0],
  [0,0,0,1,1,1,1,0,1,1,1]
]

const lettreE = [
  [0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0],
  [0,0,1,1,1,1,1,0],
  [0,1,0,0,0,0,1,1],
  [1,1,1,1,1,1,1,1],
  [1,1,0,0,0,0,0,0],
  [1,1,0,0,0,0,0,0],
  [1,1,0,0,0,0,0,0],
  [1,1,1,0,0,0,0,1],
  [0,1,1,0,0,0,1,1],
  [0,0,1,1,1,1,1,0]
]

const lettreN = [
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,1,1,1,0,0,0],
  [0,1,1,1,1,1,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0],
  [1,1,1,1,1,1,1,1,1,1,1,1]
]
const lettreB = [
  [1,1,1,1,1,1,1,1,1,0,0,0,0],
  [0,1,1,1,0,0,0,0,1,1,1,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0],
  [0,0,1,1,0,0,0,0,0,1,0,0,0],
  [0,0,1,1,0,0,0,0,1,0,0,0,0],
  [0,0,1,1,1,1,1,1,1,1,1,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,1,0],
  [0,0,1,1,0,0,0,0,0,0,0,1,1],
  [0,0,1,1,0,0,0,0,0,0,0,1,1],
  [0,0,1,1,0,0,0,0,0,0,0,1,1],
  [0,0,1,1,0,0,0,0,0,0,0,1,1],
  [0,1,1,1,1,0,0,0,0,1,1,1,0],
  [1,1,1,1,1,1,1,1,1,1,1,0,0]
];

const lettreI = [
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,0,0,0,0],
  [0,0,0,0,0,0],
  [0,0,0,0,0,0],
  [0,0,0,0,0,0],
  [0,0,1,1,0,0],
  [0,1,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [0,0,1,1,0,0],
  [1,1,1,1,1,1]
];


const butterflyPattern2 = [
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 2, 2, 1, 0, 0],
  [0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 3, 1, 2, 1, 0, 4],
  [1, 2, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 1, 4, 4, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 1, 2, 2, 2, 2, 4, 4, 4, 0],
  [1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 4, 4, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0, 0, 0],
  [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 4, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0],
];

const butterflyPattern3 = [
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 2, 2, 1, 0, 0],
  [0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 3, 1, 2, 1, 0, 4],
  [1, 2, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 1, 4, 4, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 1, 2, 2, 2, 2, 4, 4, 4, 0],
  [1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 4, 4, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0, 0, 0],
  [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 4, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0],
];

// --- CREA PATTERN PROPORZIONALI ---
// ---------------- CREATE PATTERNS ----------------
function patternWidth(pattern, size) {
  return pattern[0].length * size;
}

function createPatterns() {
  patterns = [];

  const scale = canva.width / 1200;
  const size = Math.max(minSize, 6 * scale);
  const spacing = size * 1.5;

  const word = [
    lettreB, lettreI, lettreE, lettreN,
    lettreV, lettreE, lettreN, lettreU, lettreE
  ];

  const totalWidth =
    word.reduce((sum, p) => sum + patternWidth(p, size), 0) +
    spacing * (word.length - 1);

  let x = (canva.width - totalWidth) / 2;
  const y = canva.height / 1.5;

  word.forEach(pattern => {
    patterns.push(
      new PatternStitches(pattern, palettes[0], x, y, size)
    );
    x += patternWidth(pattern, size) + spacing;
  });
}

createPatterns();

// ---------------- ANIMATION ----------------
function animate() {
  context.clearRect(0, 0, canva.width, canva.height);
  patterns.forEach(p => {
    p.draw();
    p.update();
  });
  requestAnimationFrame(animate);
}

animate();
