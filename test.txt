let agoArray = [];
function initAgo(){
  let x = -100
  let length = 300;
  let eyeWidth = 20;
  let eyeHeight = 30;
  let dx = 2;
  for (let i = 0; i < 5; i++){
    let y = randomIntFromRanger(canva.height / 4, (canva.height * 3) / 4);
    let delay = i * 20;
    agoArray.push(new Ago(x,y,length,eyeWidth,eyeHeight,dx,"#A8A9AD", delay));
  }
}

// let rett;
// function init() {
//   let x = canva.width / 2 - 250;
//   var dy = 10;
//   let y = 0;
//   rett = new Rettangolo(x, y, dy, 500, 100, "green");
// }

// function animate(){
//     requestAnimationFrame(animate);
//     context.clearRect(0,0,canva.width,canva.height);
//     rett.update();
// }

// init();
// animate();

function animateAgo() {
  requestAnimationFrame(animateAgo);
  context.clearRect(0, 0, canva.width, canva.height);
  for (let i = 0; i < agoArray.length; i++){
    
agoArray[i].update();

  }
}

const div = document.getElementById("test");

div.addEventListener("click", () => {
  initAgo();
  animateAgo();
});








class Fiber {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.dx = (Math.random() - 0.5) * 4;
    this.dy = (Math.random() - 0.5) * 4;
    this.life = 40;
  }

  update() {
    this.x += this.dx;
    this.y += this.dy;
    this.dy += 0.1;
    this.life--;
    this.draw();
  }

  draw() {
    context.strokeStyle = "#e79ebd";
    context.beginPath();
    context.moveTo(this.x, this.y);
    context.lineTo(this.x - this.dx*2, this.y - this.dy*2);
    context.stroke();
  }
}
const ago = new Ago(-100, canva.height - 250, 150, 20, 30, 2);
let rett = new RettangoloTagliabile(
  canva.width / 2,
  canva.height / 2,
  500,
  200
);

function animateAgo() {
  requestAnimationFrame(animateAgo);
  context.clearRect(0, 0, canva.width, canva.height);
  ago.update();
  rett.update();

  fibers = fibers.filter(f => f.life > 0);
  fibers.forEach(f => f.update());

  if(!splitTriggered && ago.cutPath.length > 0) {
    splitTriggered = true;
    rett.applyCut(ago.cutPath);
  }
}



let rett = new Rettangolo(
  canva.width / 2,
  canva.height / 2 - 100,
  1,
  1,
  500,
  200
);
let rett2 = new Rettangolo(
  canva.width / 2,
  canva.height / 2 + 100,
  1,
  1,
  500,
  200
);

rett.draw();
rett2.draw();


const butterflyPattern = [
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 2, 2, 1, 0, 0],
  [0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 3, 1, 2, 1, 0, 4],
  [1, 2, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 1, 4, 4, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 1, 2, 2, 2, 2, 4, 4, 4, 0],
  [1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 4, 4, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0, 0, 0],
  [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 4, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0],
];

const butterflyPattern2 = [
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 2, 2, 1, 0, 0],
  [0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 3, 1, 2, 1, 0, 4],
  [1, 2, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 1, 4, 4, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 1, 2, 2, 2, 2, 4, 4, 4, 0],
  [1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 4, 4, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0, 0, 0],
  [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 4, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0],
];

const butterflyPattern3 = [
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 2, 2, 1, 0, 0],
  [0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 2, 1, 0, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 3, 1, 2, 1, 0, 4],
  [1, 2, 2, 3, 3, 3, 2, 2, 2, 1, 2, 2, 3, 1, 4, 4, 0],
  [1, 2, 2, 2, 3, 2, 2, 2, 1, 2, 2, 2, 2, 4, 4, 4, 0],
  [1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 4, 4, 0, 0],
  [0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 0, 0, 0],
  [0, 0, 1, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 4, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0],
];


class Cucito {
  constructor(x, y, size, color) {
    this.x = x;
    this.y = y;
    this.size = size;
    this.color = color;
    this.state = 0;
    this.progress = 0;
  }

  drawSegment(x1, y1, x2, y2, p) {
    const midX = x1 + (x2 - x1) * p + Math.sin(p * Math.PI) * 1.2;
    const midY = y1 + (y2 - y1) * p + Math.cos(p * Math.PI) * 1.2;
    const width = 2.5 + Math.sin(p * Math.PI) * 1.2;

    // filo ombra
    context.strokeStyle = "rgba(0,0,0,0.25)";
    context.lineWidth = width + 2;
    context.beginPath();
    context.moveTo(x1 + 1.5, y1 + 1.5);
    context.lineTo(midX + 1.5, midY + 1.5);
    context.stroke();

    // filo principale
    context.strokeStyle = this.color;
    context.lineCap = "round";
    context.lineWidth = width;
    context.beginPath();
    context.moveTo(x1, y1);
    context.lineTo(midX, midY);
    context.stroke();

    return { x: midX, y: midY };
  }

  draw(offsetX = 0, offsetY = 0) {
    let needlePos = null;

    const x = this.x + offsetX;
    const y = this.y + offsetY;

    if (this.state === 1)
      needlePos = this.drawSegment(
        x,
        y,
        x + this.size,
        y + this.size,
        this.progress,
      );

    if (this.state >= 2)
      this.drawSegment(x, y, x + this.size, y + this.size, 1);

    if (this.state === 3)
      needlePos = this.drawSegment(
        x + this.size,
        y,
        x,
        y + this.size,
        this.progress,
      );

    if (this.state >= 4)
      this.drawSegment(x + this.size, y, x, y + this.size, 1);

    return needlePos;
  }

  update() {
    if (this.state === 1 || this.state === 3) {
      this.progress += SPEED;
      if (this.progress >= 1) {
        this.progress = 0;
        this.state++;
      }
    }
  }
}